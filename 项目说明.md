# ESP32S3监控项目

## 项目简介

这是一个基于ESP32S3开发的WiFi配置管理器项目，使用Arduino IDE开发环境。项目采用FreeRTOS任务调度，实现现代化的Web界面WiFi配置功能，支持NVS存储，具有完整的模块化C++设计架构。

## 功能特性

### 核心功能
- **WiFi自动管理**: 智能WiFi连接和重连机制
- **AP配置模式**: 无WiFi时自动启动热点配置模式
- **现代化Web界面**: 响应式设计的WiFi配置页面
- **NVS存储**: WiFi配置信息持久化存储
- **实时状态监控**: WiFi连接状态和系统信息监控
- **系统信息展示**: 芯片信息、内存使用、运行时间等

### 技术特性
- 基于FreeRTOS多任务架构
- 模块化C++面向对象设计
- RESTful API接口
- JSON数据交换格式
- 现代化UI/UX设计
- 移动端响应式适配

## 技术规格

- **开发板**: ESP32S3
- **开发环境**: Arduino IDE
- **编程语言**: C++
- **操作系统**: FreeRTOS
- **Web服务器**: ESP32 WebServer
- **存储**: NVS (Non-Volatile Storage)
- **界面**: HTML5 + CSS3 + JavaScript
- **数据格式**: JSON
- **调试方式**: printf输出（无串口配置）

## 系统架构

### 文件结构

```
ESP32S3_Monitor/
├── ESP32S3_Monitor.ino        # 主程序文件
├── Monitor.h                  # 监控器类头文件
├── Monitor.cpp                # 监控器类实现文件
├── ConfigStorage.h            # NVS配置存储类头文件
├── ConfigStorage.cpp          # NVS配置存储类实现文件
├── WiFiManager.h              # WiFi管理器类头文件
├── WiFiManager.cpp            # WiFi管理器类实现文件
├── WebServerManager.h         # Web服务器管理器类头文件
├── WebServerManager.cpp       # Web服务器管理器类实现文件
├── WebServerManager_UI.cpp    # Web界面UI实现文件
└── 项目说明.md                # 项目说明文档
```

### 类设计架构

- **Monitor类**: 核心监控器类，负责Hello World输出任务
- **ConfigStorage类**: NVS存储管理类，负责WiFi配置的持久化存储
- **WiFiManager类**: WiFi连接管理类，负责WiFi连接、重连和AP模式切换
- **WebServerManager类**: Web服务器管理类，负责HTTP服务器和API接口

### 任务设计

- **HelloWorldTask**: 优先级2，持续输出"hello world"
- **WiFiManagementTask**: 优先级3，WiFi连接状态监控和管理
- **WebServerTask**: 优先级2，处理HTTP请求和客户端连接

### API接口

- `GET /` - 主配置页面
- `GET /scan` - WiFi网络扫描
- `POST /save` - 保存WiFi配置
- `GET /status` - 获取系统状态
- `GET /info` - 获取系统信息
- `GET /restart` - 重启设备

## 使用说明

### 首次配置

1. 将程序上传到ESP32S3开发板
2. 设备启动后会自动进入AP配置模式
3. 使用手机或电脑连接WiFi热点：`ESP32S3-Config`，密码：`12345678`
4. 浏览器打开 `http://192.168.4.1` 进入配置界面
5. 扫描并选择目标WiFi网络，输入密码
6. 点击连接，设备将自动连接到指定WiFi网络
7. 连接成功后，设备会显示获得的IP地址

### 正常使用

- 设备会自动连接到已配置的WiFi网络
- 连接成功后可通过获得的IP地址访问Web界面
- WiFi连接断开时会自动尝试重连
- 重连失败会自动切换到AP配置模式

### Web界面功能

- **状态指示器**: 实时显示WiFi连接状态（已连接/AP模式/未连接）
- **WiFi扫描**: 扫描附近可用WiFi网络
- **网络列表**: 显示信号强度和安全类型
- **配置表单**: WiFi SSID和密码输入
- **系统信息**: 设备型号、固件版本、运行时间、可用内存
- **设备管理**: 重启设备、刷新信息

## 编译和运行

### 环境要求

1. Arduino IDE 1.8.19 或更高版本
2. ESP32 开发板包 v2.0.0 或更高版本
3. 所需库：
   - WiFi (ESP32内置)
   - WebServer (ESP32内置)
   - Preferences (ESP32内置)
   - ArduinoJson (需安装)

### 编译步骤

1. 在Arduino IDE中打开`ESP32S3_Monitor.ino`
2. 选择开发板：ESP32S3 Dev Module
3. 配置参数：
   - CPU Frequency: 240MHz
   - Flash Size: 16MB
   - Partition Scheme: Default 4MB with spiffs
4. 编译并上传到开发板
5. 打开串口监视器查看启动日志

## 版本更新日志

### v2.0.1 (Web界面系统信息增强) - 小版本更新
- ✅ **增强Web界面系统信息显示**
  - 新增CPU频率显示（MHz）
  - 新增Flash存储大小显示
  - 新增总内存大小显示
  - 优化系统信息布局和显示顺序
- ✅ **改进延时函数使用**
  - 统一使用vTaskDelay替代delay函数
  - 符合FreeRTOS最佳实践
  - 避免阻塞其他任务执行
- ✅ **增强WiFi AP模式启动**
  - 添加详细的AP启动调试信息
  - 增加AP启动失败时的自动重试机制
  - 优化AP配置参数设置

### v2.0.0 (WiFi配置管理器) - 重大功能更新
- ✅ **新增WiFi自动管理功能**
  - 智能WiFi连接和断线重连机制
  - AP配置模式自动切换
  - WiFi连接状态实时监控
- ✅ **新增现代化Web配置界面**
  - 响应式设计，支持移动端访问
  - 现代化UI/UX设计，渐变背景和卡片布局
  - WiFi网络扫描和信号强度显示
  - 实时状态指示器和动画效果
- ✅ **新增NVS配置存储功能**
  - WiFi配置信息持久化存储
  - 系统配置参数管理
  - 配置数据的读取、写入、清除操作
- ✅ **新增Web服务器管理器**
  - HTTP服务器和RESTful API
  - JSON数据交换格式
  - 多路由处理和错误页面
- ✅ **完整的模块化架构重构**
  - ConfigStorage类：NVS存储管理
  - WiFiManager类：WiFi连接管理
  - WebServerManager类：Web服务器管理
  - 面向对象的C++设计模式
- ✅ **FreeRTOS多任务优化**
  - WiFi管理任务（优先级3）
  - Web服务器任务（优先级2）
  - 任务优先级合理分配
- ✅ **系统信息监控**
  - 芯片型号和版本信息
  - 内存使用监控
  - 运行时间统计
  - WiFi信号强度监控

### v1.0.4 (Hello World持续输出)
- ✅ 修改Hello World任务为持续输出模式
- ✅ 每秒输出一次"hello world"
- ✅ 使用vTaskDelay实现1秒延时
- ✅ 添加循环机制，支持任务持续运行直至手动停止

### v1.0.3 (Hello World单次输出)
- ✅ 修改Hello World任务为单次输出模式
- ✅ 输出一次"hello world"后任务自动结束
- ✅ 移除无限循环和延时机制
- ✅ 优化任务生命周期管理

### v1.0.2 (修复分区表重叠问题)
- 🐛 修复partitions.csv分区表重叠问题
- 🐛 修复app分区对齐问题，确保符合0x10000边界对齐要求
- ✅ 调整app0分区起始地址从0x10000到0x20000，满足64KB边界对齐
- ✅ 优化app0和app1分区大小为0x5F0000
- ✅ 调整spiffs分区偏移到0xC00000，大小为0x2F0000
- ✅ 调整coredump分区偏移到0xEF0000，确保分区边界正确对齐

### v1.0.1 (修复任务运行问题)
- 🐛 修复任务只执行一次的竞态条件问题
- ✅ 调整isRunning标志设置时机，在任务创建前设置
- ✅ 优化任务循环逻辑，避免任务意外退出
- ✅ 确保Hello World能够持续每秒输出

### v1.0.0 (初始版本)
- ✅ 创建基础项目结构
- ✅ 实现Monitor监控器类
- ✅ 实现Hello World输出任务
- ✅ 配置FreeRTOS任务调度
- ✅ 设置任务优先级为2
- ✅ 实现每秒输出功能
- ✅ 添加模块化C++设计
- ✅ 使用printf进行调试输出
- ✅ setup()仅做初始化，loop()不处理任务

## 开发规范

1. 程序采用模块化设计，优先使用C++
2. 使用FreeRTOS进行开发，通过任务实现功能
3. setup()只做初始化，loop()不做任何任务处理
4. 使用printf输出调试信息（无串口配置）
5. 合理调整各个任务的优先级
6. WiFi配置信息保存在NVS中持久化存储
7. Web界面采用现代化响应式设计

## 故障排除

### WiFi连接问题
- 检查WiFi名称和密码是否正确
- 确认WiFi网络的加密方式（支持WPA/WPA2）
- 检查WiFi信号强度是否足够
- 尝试重启设备重新配置

### Web界面访问问题
- 确认已连接到ESP32S3-Config热点
- 检查IP地址是否正确（AP模式：192.168.4.1）
- 尝试清除浏览器缓存
- 使用不同浏览器测试

### 设备重启问题
- 检查电源供应是否稳定
- 查看串口监视器的错误日志
- 确认固件版本兼容性

## 未来计划

- [ ] 添加MQTT客户端功能
- [ ] 实现OTA固件更新
- [ ] 添加传感器数据采集
- [ ] 实现数据可视化界面
- [ ] 添加定时任务功能
- [ ] 支持多种认证方式 